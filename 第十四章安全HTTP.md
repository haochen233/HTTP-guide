# 14.1 保护HTTP的安全

HTTP的安全版本要高效、可移植且易于管理，不但能够适应不断变化的情况而且还应该能满足社会和政府的各项要求。我们需要一种能够提供下列功能的HTTP安全技术：

- 服务器认证（客户端知道它们是在与真正的而不是伪造的服务器通话）该名称有着被动的意思，即服务器被客户端认证
- 客户端认证（服务器知道它们是在与真正的而不是伪造的客户端通话）该名称有着被动的意思，即客户端被服务器认证
- 完整性（客户端和服务器的数据不会被修改）
- 加密（客户端和服务器的对话是私密的，无需担心被窃听）
- 效率（一个运行的足够快的算法。以便低端的客户端和服务器使用）
- 普适性（基本上所有的客户端和服务器都支持这些协议）
- 管理的可扩展性（在任何地方的任何人都可以立即进行安全通信）
- 适应性（能够支持当前最知名的安全方法）
- 在社会上的可行性（满足社会的政治文化需要）

## HTTPS
使用HTTPS时1，所有的HTTP请求和响应数据在发送到网络之前，都要进行加密。HTTPS在HTTP下提供了一个传输级的密码安全层（HTTP为应用层，TCP为传输层，该安全层介于TCP与HTTP之前，所以也称为传输安全层）可以使用SSL，也可以使用TSL。SSL和TSL非常相似。

# 14.2 数字加密
在详细探讨HTTPS之前，先了解一些SSL和HTTPS用到的加密编码技术的背景知识。

下面对数字加密的本质进行一个快速的入门性介绍： 

- 密码  
对文本进行编码，使偷窥者无法识别的算法
- 密钥  
改变密码行为的数字化参数
- 对称密钥加密系统  
编/解码使用相同密钥的算法
- 不对称密钥加密系统  
编/解码使用不同密钥的算法
- 公开密钥加密系统  
一种能够使百万计算机便捷地发送机密报文的系统
- 数字签名  
用来验证报文未被伪造或篡改的校验和（hash散列值）
- 数字证书  
由一个可信的组织验证和签发的识别信息

## 14.2.2 密码
密码学基于一种名为密码（cipher）的秘密代码。密码是一套编码方案————一种特殊的报文编码方式和相应的解码方式的结合体。加密之前的原始报文通常被称为明文（plaintext或cleartext）。使用了密码之后的编码报文通常被称作密文。

# 14.3 对称密钥加密技术
因为它们在编码时使用的密钥值和解码时一样（e=d）。统称为密钥k

在对称密钥加密技术中，发送端和接收端要共享相同的密钥 k 才能进行通信。。发送
端用共享的密钥来加密报文，并将得到的密文发送给接收端。接收端收到密文，并对其应用解密函数和相同的共享密钥，恢复出原始的明文。

流行的对称加密算法包括：DES、Triple-DES。

## 14.3.1 密钥长度与枚举攻击
保持密钥的机密状态是很重要的。在很多情况下，编 / 解码算法都是众所周知的，因此**密钥就是唯一保密的东西**了。

好的加密算法会迫使攻击者试遍每一个可能的密钥，才能破解代码。用暴力去尝试所有的密钥值称为枚举攻击（enumeration  attack）

# 14.4 公开密钥加密技术
公开密钥加密技术没有为每对主机使用单独的加密 / 解密密钥，而是使用了两个非对称密钥：一个用来对主机报文编码，另一个用来对主机报文解码。编码密钥是众所周知的（这也是公开密钥加密这个名字的由来） ，但只有主机才知道私有的解密密钥。

尽管每个人都可以用同一个密钥（公钥）对发送给服务器的报文进行编码，但除了服务器，其他人都无法对报文进行解码，因为只有服务器才有解码的私有密钥（私钥只有服务器有）。


## 14.4.1 RSA
所有公开密钥非对称加密系统所面临的共同挑战是，要确保即便有人拥有了下面所有的线索，也无法计算出保密的私有密钥：

- 公开密钥
- 一小片拦截下来的密文
- 一条报文与之相关的密文

RSA算法就是一个满足了这些条件的流行的公开密钥加密系统。

## 14.4.2 混合加密系统和会话密钥

但公开加密算法的计算可能会很慢。实际上它使用了对称和非对称策略。比较常见的做法是在两节点间通过便捷的公开密钥加密技术建立起安全通信，然后再用那条安全的通道产生并发送临时的随机对称密钥，之后对报文的加密与解密都使用相同的密钥（因为是对称的）来进行。所以这样能够提高性能。

# 14.5 数字签名
除了加/解密报文之外，还可以用加密系统对报文进行签名（sign），以说明是谁编写的报文，同时证明报文未被篡改过，这种技术被称为数字签名（digital signing）。比如MD5。

服务器A向客户端B发送一条报文并对其进行签名的流程：  

- 服务器A将变长的报文提取为定长的摘要（计算出来的hash散列值）
- 服务器A对该摘要使用了一个签名函数，这个函数会将服务器的私钥作为参数。
- 然后服务器计算出签名，就将其附加在报文的末尾，并将报文和签名都发送到客户端B
- 客户端B收到数据后，需要确定报文是不是服务器A写的，并且内容没有篡改过。节点B这时就可以对签名进行检查。节点B接收了经私钥扰码的签名，使用公开密钥的反函数如果拆包后的摘要与客户端B自己的摘要版本（值）不匹配，要么就是报文在传输过程中被篡改了，要么就是发送端没有服务器 A 的私有密钥（也就是说它不是服务器A）。

# 14.6 数字证书
数字证书通常还包括对象的公开密钥

## 14.6.3 用证书对于服务器进行认证

通过 HTTPS 建立了一个安全 Web 事务之后，现代的浏览器都会自动获取所连接服务器的数字证书。如果服务器没有证书，安全连接就会失败。服务器证书中包含很多字段，其中包括：  

- Web站点的名称和主机名
- Web站点的公开密钥
- 签名颁发机构的名称
- 来自签名颁发机构的签名

浏览器收到证书时会对签名颁发机构进行检查。如果这个机构是个很有权威的公共签名机构，浏览器可能已经知道其公开密钥了。

如果对签名颁发机构一无所知，浏览器就无法确定是否应该信任这个签名颁发机构，它通常会向用户显示一个对话框，看看他是否相信这个签名发布者。

# 14.7 HTTPS————细节介绍
HTTPS就是在安全的传输层上发送HTTP。HTTPS没有将未加密的HTTP报文发送给TCP，并通过世界范围内的因特网进行传输。它在将HTTP报文发送给TCP之前，先将其发送给了一个安全层，对其进行加密。

现在，HTTP 安全层是通过 SSL 及其现代替代协议 TLS 来实现的。我们遵循常见的用法，用术语 SSL 来表示 SSL 或者 TLS。

## 14.7.1 HTTPS方案
- 如果URL的方案（schema）是http，客户端就会打开一条道服务器端口80的连接（默认情况下），并将其发送老的HTTP命令
- 如果URL的方案为https，客户端就会打开一条到服务器端口 443（默认情况下）的连接。以二进制格式与服务器交换一些 SSL 安全参数，附上加密的 HTTP 命令。

## 14.7.2 建立安全传输
在未加密 HTTP 中，客户端会打开一条到 Web 服务器端口 80 的 TCP 连接，发送一条请求报文，接收一条响应报文，关闭连接。

由于 SSL 安全层的存在，HTTPS 中这个过程会略微复杂一些。在 HTTPS 中，客户端首先打开一条到 Web 服务器端口 443（安全 HTTP 的默认端口）的连接。一旦建立了 TCP 连接，客户端和服务器就会初始化 SSL 层，对加密参数进行沟通，并交换密钥。握手完成之后，SSL 初始化就完成了，客户端就可以将请求报文发送给安全层了。在将这些报文发送给 TCP 之前，要先对其进行加密。